$webResourceManager.requireResource("com.redhat.engineering.plugins.planning-poker:planning-poker-resources")

<html>
<head>
    <title>Instant Planning Poker</title>
    <meta name="decorator" content="atl.popup"/>
    <style>
        .instant-vote-container { padding: 20px; }
        .voting-cards { margin: 20px 0; text-align: center; }
        .card {
            display: inline-block;
            width: 60px;
            height: 80px;
            margin: 5px;
            border: 2px solid #ccc;
            border-radius: 5px;
            line-height: 80px;
            font-size: 24px;
            cursor: pointer;
            background: #f5f5f5;
            transition: all 0.2s;
        }
        .card:hover { background: #e3f2fd; border-color: #2196f3; }
        .card.selected { background: #2196f3; color: white; border-color: #1976d2; }
        .comment-area { margin: 20px 0; }
        .comment-area textarea { width: 100%; min-height: 60px; }
        .action-buttons { margin: 20px 0; text-align: center; }
        .action-buttons button { margin: 0 10px; }
        .results-section { margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 5px; }
        .stat-row { display: flex; justify-content: space-around; margin: 10px 0; }
        .stat-item { text-align: center; }
        .stat-label { font-size: 12px; color: #666; }
        .stat-value { font-size: 24px; font-weight: bold; color: #2196f3; }
        .apply-buttons { margin-top: 20px; text-align: center; }
        .apply-buttons button { margin: 0 10px; }
        #loading { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div class="instant-vote-container">
    <div id="loading">Loading...</div>

    <div id="voting-section">
        <h3>Select Your Estimate</h3>

        <div class="voting-cards">
            #foreach($allowedVote in $action.allowedVotes)
                <div class="card" data-value="$allowedVote">$allowedVote</div>
            #end
        </div>

        <div class="comment-area">
            <label for="vote-comment">Comment (optional):</label>
            <textarea id="vote-comment" class="textarea"></textarea>
        </div>

        <div class="action-buttons">
            <button id="vote-btn" class="aui-button aui-button-primary" disabled>Vote</button>
            #if($action.isCreator())
                <button id="end-session-btn" class="aui-button" style="display:none;">End Session & Show Results</button>
            #end
        </div>
    </div>

    <div id="results-section" style="display:none;">
        <h3>Session Results</h3>
        <div id="results-content"></div>
    </div>
</div>

<script type="text/javascript">
(function() {
    var issueKey = '${key}';
    var selectedValue = null;
    var isCreator = ${action.isCreator()};

    // Card selection
    AJS.$('.card').on('click', function() {
        AJS.$('.card').removeClass('selected');
        AJS.$(this).addClass('selected');
        selectedValue = AJS.$(this).data('value');
        AJS.$('#vote-btn').prop('disabled', false);
    });

    // Vote button
    AJS.$('#vote-btn').on('click', function() {
        var comment = AJS.$('#vote-comment').val();
        AJS.$('#loading').show();

        AJS.$.ajax({
            url: AJS.contextPath() + '/secure/PokerVote.jspa',
            type: 'POST',
            data: {
                key: issueKey,
                action: 'vote',
                voteVal: selectedValue,
                voteComment: comment,
                atl_token: AJS.$('meta[name="atlassian-token"]').attr('content')
            },
            success: function() {
                AJS.$('#loading').hide();
                AJS.flag({
                    type: 'success',
                    title: 'Success',
                    body: 'Vote saved successfully!',
                    close: 'auto'
                });

                // Show end session button for creator
                if (isCreator) {
                    AJS.$('#end-session-btn').show();
                }
            },
            error: function(xhr) {
                AJS.$('#loading').hide();
                AJS.flag({
                    type: 'error',
                    title: 'Error',
                    body: 'Failed to save vote: ' + xhr.responseText
                });
            }
        });
    });

    // End session button
    AJS.$('#end-session-btn').on('click', function() {
        if (!confirm('End this session and show results?')) {
            return;
        }

        AJS.$('#loading').show();

        AJS.$.ajax({
            url: AJS.contextPath() + '/secure/PokerVote.jspa',
            type: 'POST',
            data: {
                key: issueKey,
                action: 'endSession',
                atl_token: AJS.$('meta[name="atlassian-token"]').attr('content')
            },
            success: function() {
                // Load results
                loadResults();
            },
            error: function(xhr) {
                AJS.$('#loading').hide();
                AJS.flag({
                    type: 'error',
                    title: 'Error',
                    body: 'Failed to end session'
                });
            }
        });
    });

    // Load results
    function loadResults() {
        AJS.$.ajax({
            url: AJS.contextPath() + '/secure/PokerVote.jspa',
            type: 'GET',
            data: {
                key: issueKey,
                getStats: 'true'
            },
            success: function(response) {
                AJS.$('#loading').hide();
                AJS.$('#voting-section').hide();
                AJS.$('#results-section').show();

                // Parse stats from response or use dummy data for now
                var stats = {
                    min: response.min || 'N/A',
                    max: response.max || 'N/A',
                    average: response.average || 'N/A',
                    count: response.count || 0
                };

                var html = '<div class="results-content">';
                html += '<div class="stat-row">';
                html += '<div class="stat-item"><div class="stat-label">Minimum</div><div class="stat-value">' + stats.min + '</div></div>';
                html += '<div class="stat-item"><div class="stat-label">Maximum</div><div class="stat-value">' + stats.max + '</div></div>';
                html += '<div class="stat-item"><div class="stat-label">Average</div><div class="stat-value">' + stats.average + '</div></div>';
                html += '<div class="stat-item"><div class="stat-label">Total Votes</div><div class="stat-value">' + stats.count + '</div></div>';
                html += '</div>';

                if (isCreator && stats.count > 0) {
                    html += '<div class="apply-buttons">';
                    html += '<button class="aui-button apply-estimate" data-value="' + stats.min + '">Apply Min (' + stats.min + ')</button>';
                    html += '<button class="aui-button apply-estimate" data-value="' + stats.average + '">Apply Average (' + stats.average + ')</button>';
                    html += '<button class="aui-button apply-estimate" data-value="' + stats.max + '">Apply Max (' + stats.max + ')</button>';
                    html += '</div>';
                }
                html += '</div>';

                AJS.$('#results-content').html(html);

                // Bind apply estimate buttons
                AJS.$('.apply-estimate').on('click', function() {
                    applyEstimate(AJS.$(this).data('value'));
                });
            },
            error: function() {
                AJS.$('#loading').hide();
                AJS.flag({
                    type: 'error',
                    title: 'Error',
                    body: 'Failed to load results'
                });
            }
        });
    }

    // Apply estimate
    function applyEstimate(value) {
        AJS.$('#loading').show();

        AJS.$.ajax({
            url: AJS.contextPath() + '/secure/PokerVote.jspa',
            type: 'POST',
            data: {
                key: issueKey,
                action: 'applyEstimate',
                finalValue: value,
                atl_token: AJS.$('meta[name="atlassian-token"]').attr('content')
            },
            success: function() {
                AJS.$('#loading').hide();
                AJS.flag({
                    type: 'success',
                    title: 'Success',
                    body: 'Estimate ' + value + ' applied to issue!',
                    close: 'auto'
                });

                // Close dialog and reload page after 1.5 seconds
                setTimeout(function() {
                    if (window.parent && window.parent.location) {
                        window.parent.location.reload();
                    } else {
                        window.location.reload();
                    }
                }, 1500);
            },
            error: function(xhr) {
                AJS.$('#loading').hide();
                AJS.flag({
                    type: 'error',
                    title: 'Error',
                    body: 'Failed to apply estimate'
                });
            }
        });
    }
})();
</script>

</body>
</html>
