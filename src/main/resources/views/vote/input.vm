#macro(activate $voteVal $actualVal)
    #if ($voteVal == $actualVal)
        active
    #end
#end

#set($isInstant = $action.isInstantMode())
#set($sessionEnded = $action.isSessionEnded())
#set($isCreator = $action.isCreator())
#set($session = $action.session)
#set($issueKey = $session.issue.key)

#if(!$isInstant)
<html>
<head>
    <title>Vote</title>
    <meta name="decorator" content="issueaction" />
</head>
<body>
#end


<!-- Main voting content (always shown) -->
<div id="instant-vote-wrapper" data-is-instant="$isInstant" data-is-creator="$isCreator" data-issue-key="$issueKey">
#if(!$sessionEnded)
    <!-- Voting Section -->
    <style>
        .card {
            display: inline-block;
            width: 2.1em;
            height: 3em;
            margin: 0;
            -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
            -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid transparent;
            border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
            border-bottom-color: #A2A2A2;
            position: relative;
            -webkit-border-radius: 0.2em;
            border-radius: 0.2em;
            color: #25201c;
            font-size: 1.5em;
            text-align: center;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.75);
            line-height: 3em;
            cursor: pointer;
            background-color: rgb(224, 230, 230);
            margin-bottom: 3px;
        }
        .card:hover {
            background-color: #6baff4;
        }
        .card.active {
            background-color: #3b7fc4;
            color: white;
        }
        .cards-row {
            margin: 5px;
        }
        .cards {
            margin: 0 90px;
            margin-bottom: 20px;
        }
    </style>

    <form action="PokerVote.jspa" id="vote-poker" class="aui" method="post">
        <input type="hidden" name="atl_token" value="$atl_token">
        <div class="form-body">
            <h2 class="dialog-title">Vote</h2>

            <!-- Voting cards -->
            <div id="poker-vote-cards" class="cards">
                <div class="cards-row">
                    #foreach($allowedVote in $action.allowedVotes)
                        <div class="card #activate($voteVal $allowedVote)" data-value="$allowedVote">$allowedVote</div>
                    #end
                </div>
            </div>

            <!-- Comment field -->
            <div class="field-group">
                <label for="voteComment">Comment</label>
                <textarea id="voteComment" name="voteComment" class="textarea" cols="40" rows="3">#if($voteComment)$voteComment#end</textarea>
            </div>

            <div class="hidden">
                <input type="hidden" name="voteVal" class="text" id="poker-vote-value" value="${voteVal}"/>
                <input type="hidden" name="key" value="$issueKey" />
            </div>
        </div>
    

        <div class="buttons-container form-footer">
            <div class="buttons">
                #if($isInstant && $isCreator)
                <!-- End session button (creator only, instant mode only) - Hidden until creator votes -->
                <button type="button" id="end-session-btn" class="aui-button aui-button-primary">
                    Finish Session
                </button>
                #end
                <input accesskey="s" class="button" id="poker-vote-submit"
                       name="Vote" title="Press Ctrl+Alt+s to submit this form"
                       type="submit" value="Vote">
                <a accesskey="`" class="cancel" href="/browse/$issueKey" id="vote-poker-cancel"
                   title="Press Ctrl+Alt+` to cancel">Cancel</a>
            </div>
        </div>


    </form>

    #if(!$isInstant)
    <script type="text/javascript">
        (function() {
            var cards = document.getElementsByClassName("card");
            for (var i = 0; i < cards.length; i++) {
                cards[i].addEventListener("click", function() {
                    for (var j = 0; j < cards.length; j++) {
                        cards[j].classList.remove("active");
                    }
                    this.classList.add("active");
                    document.getElementById("poker-vote-value").value = this.getAttribute("data-value");
                });
            }
        })();
    </script>
    #end
#end

<!-- Results section (shown when session ended) -->
#if($sessionEnded)
    #set($stats = $action.sessionStats)
    <div id="results-section">
        <h3>Session Results</h3>

        #if($stats && !$stats.isEmpty())
            <div class="instant-poker-stats">
                <div class="stat-item">
                    <span class="stat-label">Minimum:</span>
                    <span class="stat-value">$stats.get("min")</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Maximum:</span>
                    <span class="stat-value">$stats.get("max")</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Average:</span>
                    <span class="stat-value">$stats.get("average")</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Votes:</span>
                    <span class="stat-value">$stats.get("count")</span>
                </div>
            </div>

            #if($isCreator && $isInstant)
                <h4>Apply Final Estimate</h4>
                <div class="buttons-container">
                    <button type="button" class="aui-button apply-estimate" data-value="$stats.get('min')">
                        Apply Min ($stats.get("min"))
                    </button>
                    <button type="button" class="aui-button apply-estimate" data-value="$stats.get('average')">
                        Apply Average ($stats.get("average"))
                    </button>
                    <button type="button" class="aui-button apply-estimate" data-value="$stats.get('max')">
                        Apply Max ($stats.get("max"))
                    </button>
                </div>
            #end
        #else
            <p>No votes cast yet.</p>
        #end
    </div>
#end

<!-- Session details section (only in instant mode) -->
#if($isInstant && !$sessionEnded)
    <div id="session-details" style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
        <h3>Session Details</h3>

        <ul class="item-details">
            <li class="people-details">
                <dl>
                    <dt>Author:</dt>
                    <dd>
                        <span class="view-issue-field">$action.getAuthorHtml($session)</span>
                    </dd>
                </dl>
            </li>
        </ul>

        <ul class="item-details">
            <li>
                <dl class="score">
                    <dt>Status:</dt>
                    <dd>
                        #set($status = $action.getStatus($session))
                        #if ($status == "SCHEDULED")
                        <span class="aui-lozenge aui-lozenge-subtle aui-lozenge-complete">Scheduled</span>
                        #elseif ($status == "IN_PROGRESS")
                        <span class="aui-lozenge aui-lozenge-subtle jira-issue-status-lozenge-yellow">In Progress</span>
                        #elseif ($status == "FINISHED")
                        <span class="aui-lozenge aui-lozenge-subtle aui-lozenge-error">Finished</span>
                        #end
                    </dd>
                </dl>
                <dl class="votes">
                    <dt>Votes:</dt>
                    <dd>
                        <span class="aui-badge" id="votes-count">$action.getVotesSize($session)</span>
                    </dd>
                </dl>
            </li>
        </ul>

        <ul class="item-details">
            <li>
                <dl>
                    <dt>Who Voted:</dt>
                    <dd id="voters-list">
                        #set($voters = $action.getVoters())
                        #if($voters && $voters.size() > 0)
                            #foreach($voter in $voters)
                                <span class="aui-avatar aui-avatar-xsmall" style="display: inline-block; margin-right: 5px;">
                                    <span class="aui-avatar-inner">
                                        <img src="$action.getAvatarURL($voter)" alt="$voter.displayName" title="$voter.displayName">
                                    </span>
                                </span>
                            #end
                        #else
                            <span class="no-voters">No votes yet</span>
                        #end
                    </dd>
                </dl>
            </li>
        </ul>
    </div>
#end
</div>

#if($isInstant)
$webResourceManager.requireResource("com.redhat.engineering.plugins.planning-poker:instant-poker-resources")
#end

#if(!$isInstant)
</body>
</html>
#end
